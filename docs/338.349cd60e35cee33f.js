"use strict";(self.webpackChunkemporium=self.webpackChunkemporium||[]).push([[338],{4338:(_,A,n)=>{n.r(A),n.d(A,{SignInModule:()=>m,routes:()=>w});var O=n(6895),T=n(9132),a=n(4006),F=n(4508),S=n(5861),b=n(8955),M=n(3071),E=n(2340),x=n(5783),g=n(5412),e=n(4650),c=n(1576),P=n(4859),L=n(4144),d=n(9549),C=n(3081);function N(l,o){1&l&&(e.TgZ(0,"mat-error"),e._uU(1,"Code is required"),e.qZA())}class p{constructor(o,t,i){this.dialogRef=o,this.data=t,this.fb=i}ngOnInit(){this.form=this.fb.group({otp:[null,a.kI.required]})}onSubmit(){console.log(this.form.value),this.form.valid&&this.dialogRef.close(this.form.value)}onSave(){this.form.valid&&(this.action="Ok",this.dialogRef.close({event:this.action,data:this.form.value}))}close(){this.action="Cancel",this.dialogRef.close({event:this.action})}}p.\u0275fac=function(o){return new(o||p)(e.Y36(g.so),e.Y36(g.WI),e.Y36(a.QS))},p.\u0275cmp=e.Xpm({type:p,selectors:[["app-otp-dialog"]],decls:21,vars:16,consts:[["mat-dialog-title",""],["autocomplete","off",3,"formGroup"],["mat-dialog-content",""],["fxLayout","row wrap"],["fxFlex","100","fxFlex.gt-sm","90.0",1,"px-1"],["appearance","outline",1,"w-100"],["matInput","","formControlName","otp","required",""],[4,"ngIf"],["mat-dialog-actions",""],["fxLayout","row","fxLayoutAlign","space-between center",1,"w-100"],["mat-raised-button","","color","primary",3,"mat-dialog-close","disabled","click"],["mat-raised-button","","color","warn",3,"click"]],template:function(o,t){1&o&&(e.TgZ(0,"h4",0),e._uU(1),e.ALo(2,"translate"),e.qZA(),e.TgZ(3,"form",1)(4,"div",2)(5,"div",3)(6,"div",4)(7,"mat-form-field",5)(8,"mat-label"),e._uU(9),e.ALo(10,"translate"),e.qZA(),e._UZ(11,"input",6),e.YNc(12,N,2,0,"mat-error",7),e.qZA()()()(),e.TgZ(13,"div",8)(14,"div",9)(15,"button",10),e.NdJ("click",function(){return t.onSave()}),e._uU(16),e.ALo(17,"translate"),e.qZA(),e.TgZ(18,"button",11),e.NdJ("click",function(){return t.close()}),e._uU(19),e.ALo(20,"translate"),e.qZA()()()()),2&o&&(e.xp6(1),e.Oqu(e.lcZ(2,8,t.data.cttRow)),e.xp6(2),e.Q6J("formGroup",t.form),e.xp6(6),e.Oqu(e.lcZ(10,10,"HTML.OTPCode")),e.xp6(3),e.Q6J("ngIf",null==t.form.controls.otp.errors?null:t.form.controls.otp.errors.required),e.xp6(3),e.Q6J("mat-dialog-close",t.form.value)("disabled",!t.form.valid),e.xp6(1),e.Oqu(e.lcZ(17,12,"BTN.OK")),e.xp6(3),e.Oqu(e.lcZ(20,14,"BTN.CANCEL")))},dependencies:[O.O5,a._Y,a.Fj,a.JJ,a.JL,a.Q7,a.sg,a.u,c.xw,c.Wh,c.yH,P.lW,g.ZT,g.uh,g.xY,g.H8,L.Nt,d.KE,d.hX,d.TO,C.X$]});var y=n(4459),D=n(6805),R=n(930);function Z(l,o){const t="object"==typeof o;return new Promise((i,s)=>{const r=new R.Hp({next:f=>{i(f),r.unsubscribe()},error:s,complete:()=>{t?i(o.defaultValue):s(new D.K)}});l.subscribe(r)})}var k=n(7009),B=n(5298),V=n(7465),Y=n(2854),J=n(4165),G=n(6002),q=n(1182),Q=n(3546),H=n(7392);function K(l,o){1&l&&(e.TgZ(0,"mat-error"),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&l&&(e.xp6(1),e.Oqu(e.lcZ(2,1,"HTML.USERNAMEREQ")))}function X(l,o){1&l&&(e.TgZ(0,"mat-error"),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&l&&(e.xp6(1),e.Oqu(e.lcZ(2,1,"MESSAGE.MinLength")))}function W(l,o){1&l&&(e.TgZ(0,"mat-error"),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&l&&(e.xp6(1),e.Oqu(e.lcZ(2,1,"HTML.PasswordREQ")))}function $(l,o){1&l&&(e.TgZ(0,"mat-error"),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&l&&(e.xp6(1),e.Oqu(e.lcZ(2,1,"MESSAGE.MinLength6")))}class h{constructor(o,t,i,s,r,f,I,U,u,v,j,z){this.formBuilder=o,this.router=t,this.snackBar=i,this.localStore=s,this.userService=r,this.global=f,this.staff=I,this.settingService=U,this.dialog=u,this.translateService=v,this.atlasService=j,this.appSettings=z,this.curBraId=E.N.braid,this.account=new x.n,this.codeForSendOTP=(new y.$).getisAppSendOTP(),this.codeForOTPLength=(new y.$).getlengthOfOTP(),this.statusData=null,this.error=null,this.loading=!0,this.allowedChar="1234567890",this.settings=this.appSettings.settings}ngOnInit(){this.loginForm=this.formBuilder.group({username:["",a.kI.compose([a.kI.required,a.kI.minLength(3)])],password:["",a.kI.compose([a.kI.required,a.kI.minLength(6)])]}),this.registerForm=this.formBuilder.group({username:["",a.kI.compose([a.kI.required,a.kI.minLength(3)])],first_name:["",a.kI.compose([a.kI.required,a.kI.minLength(3)])],email:["",a.kI.compose([a.kI.required,b.Le])],password:["",a.kI.required],confirmPassword:["",a.kI.required]},{validator:(0,b.zi)("password","confirmPassword")}),this.prepareMsgLanguage(),this.setInitialValues()}getParamValueLegnthOfOTP2(o,t,i){this.settingService.getValueForCode(o,t,i).subscribe(s=>{if(s&&s.length>0&&s[0].APAValue)return this.lengthOfCode=s[0].APAValue,s[0].APAValue},s=>{this.snackBar.open("\u062e\u0637\u0623 \u0641\u064a \u0627\u0633\u062a\u0631\u062c\u0627\u0639 \u062e\u064a\u0627\u0631\u0627\u062a \u0627\u0644\u0646\u0638\u0627\u0645","\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3})})}getParamValueLegnthOfOTP(o,t,i){var s=this;return(0,S.Z)(function*(){console.log("--------1111111-----------");try{const r=yield Z(s.settingService.getValueForCode(o,t,i));if(r&&r.length>0&&r[0].APAValue)return s.lengthOfCode=r[0].APAValue,console.log("lengthOfCode:: "+s.lengthOfCode),r[0].APAValue}catch(r){throw s.snackBar.open("\u062e\u0637\u0623 \u0641\u064a \u0627\u0633\u062a\u0631\u062c\u0627\u0639 \u062e\u064a\u0627\u0631\u0627\u062a \u0627\u0644\u0646\u0638\u0627\u0645","\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3}),r}})()}getParamValueAppSendOTP2(o,t,i){this.settingService.getValueForCode(o,t,i).subscribe(s=>{if(s&&s.length>0&&s[0].APAValue)return this.appSendOTP=s[0].APAValue,s[0].APAValue},s=>{this.snackBar.open("\u062e\u0637\u0623 \u0641\u064a \u0627\u0633\u062a\u0631\u062c\u0627\u0639 \u062e\u064a\u0627\u0631\u0627\u062a \u0627\u0644\u0646\u0638\u0627\u0645","\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3})})}getParamValueAppSendOTP(o,t,i){var s=this;return(0,S.Z)(function*(){console.log("------2222222-------"),console.log("-----comId::"+o),console.log("-----priority::"+t),console.log("-----code::"+i);try{const r=yield Z(s.settingService.getValueForCode(o,t,i));return r&&r.length>0&&r[0].APAValue?(s.appSendOTP=r[0].APAValue,console.log("sendOTP:: "+s.appSendOTP),r[0].APAValue):(s.appSendOTP="",console.log("sendOTP is empty"),"")}catch(r){throw s.appSendOTP="",s.snackBar.open("\u062e\u0637\u0623 \u0641\u064a \u0627\u0633\u062a\u0631\u062c\u0627\u0639 \u062e\u064a\u0627\u0631\u0627\u062a \u0627\u0644\u0646\u0638\u0627\u0645","\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3}),r}})()}prepareMsgLanguage(){this.translateService.get("MESSAGE.LOGGEDIN").subscribe(o=>{this.loggedInMsg=o}),this.translateService.get("MESSAGE.NOTLOGGEDIN").subscribe(o=>{this.notLoggedInMsg=o}),this.translateService.get("MESSAGE.COMPANY_NOTLOGGEDIN").subscribe(o=>{this.usernotInCompanyMsg=o}),this.translateService.get("MESSAGE.REGISTERD").subscribe(o=>{this.registeredMsg=o}),this.translateService.get("MESSAGE.NOTREGISTERD").subscribe(o=>{this.notRegisteredMsg=o}),this.translateService.get("MESSAGE.EnterMsgSentTo").subscribe(o=>{this.enterMsgSentTo=o})}getOneUser(o){console.log("**** sign-in.component line 103 *****getOneUser::: "+o),this.staff.getOneUserbyId(o).subscribe(t=>{this.global.me=t})}resetPassword(){this.router.navigate(["resetpassword"])}onLoginFormSubmit(o){var t=this;this.subdomainCOMId=this.localStore.getItem("COMId")??null,this.loginForm.valid&&(this.localStore.setItem("userSession","active"),localStorage.setItem("windowCount","1"),this.global.userLoggedIn=!1,this.localStore.setItem("isUserLoggedIn","false"),this.userService.login(this.loginForm).subscribe(function(){var i=(0,S.Z)(function*(s){if(t.curCOMId=s.user.COMId,console.log("----curCOMId:: "+t.curCOMId+"  ** subdomainCOMId:: "+t.subdomainCOMId),t.curCOMId!=t.subdomainCOMId)return t.global.userLoggedIn=!1,t.localStore.setItem("isUserLoggedIn","false"),t.snackBar.open(t.usernotInCompanyMsg,"\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3}),t.snackBar.open("----curCOMId:: "+t.curCOMId+"  ** subdomainCOMId:: "+t.subdomainCOMId,"\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3}),void t.router.navigate(["/"]).then(()=>{window.location.reload()});console.log("-------Check Subscription-------"),t.atlasService.getSubscriptionStatus(t.subdomainCOMId).subscribe({next:r=>{if(t.statusData=r,t.loading=!1,console.log("this.statusData.status:: "+t.statusData.status),console.log("this.statusData.company_id:: "+t.statusData.company_id),console.log("this.statusData.subscription_type:: "+t.statusData.subscription_type),console.log("this.statusData.isTrial:: "+t.statusData.isTrial),console.log("this.statusData.isActive:: "+t.statusData.isActive),console.log("this.statusData.trial_remaining_days:: "+t.statusData.trial_remaining_days),console.log("this.statusData.subscription_remaining_days:: "+t.statusData.subscription_remaining_days),!t.statusData.isActive)return t.snackBar.open("\u0627\u0646\u062a\u0647\u0649 \u0627\u0644\u062a\u0633\u062c\u064a\u0644: \u0628\u0631\u062c\u0627\u0621 \u0627\u0644\u0627\u0634\u062a\u0631\u0627\u0643 \u0644\u0625\u0633\u062a\u0645\u0631\u0627\u0631 \u0627\u0644\u0639\u0645\u0644.","\xd7",{panelClass:"error",verticalPosition:"top",duration:6e3}),void t.router.navigate(["/"]).then(()=>{window.location.reload()})},error:r=>{t.error=r.message,t.loading=!1,console.log("---Subscribtion error:: "+r.message),t.snackBar.open("** subdomainCOMId:: "+t.subdomainCOMId+"  Error in Subscribtion","\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3}),t.snackBar.open(r.message,"\xd7",{panelClass:"error",verticalPosition:"top",duration:9e3}),t.router.navigate(["/"]).then(()=>{window.location.reload()})}}),t.localStore.setItem("token",s.token),t.global.me=s.user,t.global.userLoggedIn=!0,t.localStore.setItem("isUserLoggedIn","true"),yield t.getParamValueLegnthOfOTP(t.curCOMId,s.user.RowConfirm,t.codeForOTPLength),yield t.getParamValueAppSendOTP(t.curCOMId,s.user.RowConfirm,t.codeForSendOTP),console.log("------3333333---------"),console.log("---this.appSendOTP:: ${this.appSendOTP}"+t.appSendOTP),console.log("------3333333---------"),t.appSendOTP&&"YES"!=t.appSendOTP.toUpperCase()||s.user.is_superuser?(console.log("------444444-------"),console.log("this.settingService.getAppSetup"),t.settingService.getAppSetup(s.user.COMId,0).subscribe(r=>{t.localStore.setItem("appsetup",JSON.stringify(r[0]))},r=>{console.log("----responSetup ERROR:: "),console.log(r)}),console.log("this.userService.getUserPermission"),s.user.is_superuser?t.localStore.setItem("permissions",JSON.stringify([])):t.userService.getUserPermission(s.user.id).subscribe(r=>{console.log("---respPermission Success"),t.localStore.setItem("permissions",JSON.stringify(r.user_permissions))},r=>{console.log("----respPermission ERROR:: "),console.log(r)}),t.snackBar.open(t.loggedInMsg,"\xd7",{panelClass:"success",verticalPosition:"top",duration:3e3}),t.waitAndNavigate()):(console.log("----\u0627\u0644\u062a\u0637\u0628\u064a\u0642 \u064a\u0631\u0633\u0644 OTP--"),t.openOTPDialog(s.user,s.token,s.user.id,s.user.UserMobile,s.user.COMId))});return function(s){return i.apply(this,arguments)}}(),i=>{this.global.userLoggedIn=!1,this.localStore.setItem("isUserLoggedIn","false"),this.snackBar.open(this.notLoggedInMsg,"\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3}),this.router.navigate(["/"]).then(()=>{window.location.reload()})}))}delay(o){return new Promise(t=>setTimeout(t,o))}waitAndNavigate(){var o=this;return(0,S.Z)(function*(){yield o.delay(2e3),o.router.navigate(["/"]).then(()=>{o.global.loadUserData()})})()}onRegisterFormSubmit(o){this.registerForm.valid?this.userService.registerUser(this.registerForm).subscribe(t=>{this.snackBar.open(this.registeredMsg,"\xd7",{panelClass:"success",verticalPosition:"top",duration:3e3}),this.router.navigate(["/units/unit"])},t=>{console.log("error",t),this.snackBar.open(this.notRegisteredMsg,"\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3})}):(console.log("this.registerForm not valid"),this.snackBar.open(this.notRegisteredMsg,"\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3}))}setInitialValues(){this.newUser={id:null,username:"",UserCode:null,first_name:"",last_name:"",UserBirthDate:null,EntryDate:null,joinedDate:null,UserMobile:"",email:"",is_superuser:!1,is_staff:!1,is_active:!0,is_employee:"T",periorty:0,COMId:this.curCOMId,branch_KeyField:null,customer_KeyField:null,userPicture:null,gender:"",password:"",repassword:"",is_teacher:"F",RowDelete:0,LoginFrom:"N",userJobName:"",userFacebook:"",userTwitter:"",userGoogle:"",userAddress:""}}mapRegisterFormTo_UserClass(){this.newUser.username=this.registerForm.value.username,this.newUser.email=this.registerForm.value.email,this.newUser.password=this.registerForm.value.password,this.newUser.repassword=this.registerForm.value.confirmPassword}mapToOneUser(){this.oneuser.username=this.registerForm.value.username,this.oneuser.email=this.registerForm.value.email}openOTPDialog(o,t,i,s,r){var f=s.substring(s.length-3);this.localStore.setItem("token",t),this.otpCode=this.createRandomString(this.lengthOfCode,this.allowedChar);let I=this.settings.name+" \u0623\u0631\u0633\u0644 \u0627\u0644\u064a\u0643 \u0627\u0644\u0643\u0648\u062f "+this.otpCode+" \u0641\u0636\u0644\u0627\u064b \u0627\u0633\u062a\u062e\u062f\u0645\u0647 \u0644\u0644\u062f\u062e\u0648\u0644";console.log("--smsMsg:: "+I),this.atlasService.sendTaqnyatSMS(this.curCOMId,0,s,I).subscribe(u=>{console.log("-----sendTaqnyatSMS response:: ",u)},u=>{console.log("-----sendTaqnyatSMS error:: ",u)}),this.dialog.open(p,{data:{cttRow:this.enterMsgSentTo+"  "+f+"*******"},panelClass:["theme-dialog"],autoFocus:!1,direction:this.settings.rtl?"rtl":"ltr"}).afterClosed().subscribe(u=>{"Cancel"==u.event?(this.global.userLoggedIn=!1,this.localStore.setItem("isUserLoggedIn","false"),this.snackBar.open(this.notLoggedInMsg,"\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3}),this.router.navigate(["/"]).then(()=>{window.location.reload()})):"Ok"==u.event&&(u.data.otp==this.otpCode?(console.log("---EQUAL----"),this.localStore.setItem("token",t),this.global.me=o,this.global.userLoggedIn=!0,this.localStore.setItem("isUserLoggedIn","true"),this.settingService.getAppSetup(r,0).subscribe(v=>{this.localStore.setItem("appsetup",JSON.stringify(v[0]))}),this.userService.getUserPermission(i).subscribe(v=>{this.localStore.setItem("permissions",JSON.stringify(v.user_permissions))}),this.snackBar.open(this.loggedInMsg,"\xd7",{panelClass:"success",verticalPosition:"top",duration:3e3}),this.waitAndNavigate()):(console.log("---not EQUAL----"),this.global.userLoggedIn=!1,this.localStore.setItem("isUserLoggedIn","false"),this.snackBar.open(this.notLoggedInMsg,"\xd7",{panelClass:"error",verticalPosition:"top",duration:3e3}),this.router.navigate(["/"]).then(()=>{window.location.reload()})))})}createRandomString(o,t){let i="";for(let s=0;s<o;s++)i+=t.charAt(Math.floor(Math.random()*t.length));return i}}h.\u0275fac=function(o){return new(o||h)(e.Y36(a.QS),e.Y36(T.F0),e.Y36(k.ux),e.Y36(B.C),e.Y36(M.K),e.Y36(V.U),e.Y36(Y.x),e.Y36(J.g),e.Y36(g.uw),e.Y36(C.sK),e.Y36(G.Z),e.Y36(q.d))},h.\u0275cmp=e.Xpm({type:h,selectors:[["app-sign-in"]],features:[e._Bn([M.K])],decls:32,vars:21,consts:[[1,"p-4"],["fxLayout","row wrap"],["fxFlex","100","fxFlex.gt-sm","50",1,"p-3"],[1,"text-muted","text-center","mb-3"],[3,"formGroup"],["appearance","outline",1,"w-100","mt-2"],["matInput","","formControlName","username","required","",3,"placeholder"],[4,"ngIf"],["appearance","outline",1,"w-100","mt-1"],["matInput","","formControlName","password","type","password","required","",3,"placeholder"],[1,"text-center","mt-2"],["mat-fab","","color","primary",1,"mat-elevation-z6",3,"click"],["fxLayout","row","fxLayoutAlign","space-between center",1,"mt-3"],[1,"divider","w-100"],[1,"text-muted","auth"]],template:function(o,t){1&o&&(e.TgZ(0,"mat-card",0)(1,"div",1)(2,"div",2)(3,"h2",3),e._uU(4),e.ALo(5,"translate"),e.qZA(),e.TgZ(6,"form",4)(7,"mat-form-field",5)(8,"mat-label"),e._uU(9),e.ALo(10,"translate"),e.qZA(),e._UZ(11,"input",6),e.ALo(12,"translate"),e.YNc(13,K,3,3,"mat-error",7),e.YNc(14,X,3,3,"mat-error",7),e.qZA(),e.TgZ(15,"mat-form-field",8)(16,"mat-label"),e._uU(17),e.ALo(18,"translate"),e.qZA(),e._UZ(19,"input",9),e.ALo(20,"translate"),e.YNc(21,W,3,3,"mat-error",7),e.YNc(22,$,3,3,"mat-error",7),e.qZA(),e.TgZ(23,"div",10)(24,"button",11),e.NdJ("click",function(){return t.onLoginFormSubmit(t.loginForm.value)}),e.TgZ(25,"mat-icon"),e._uU(26,"key"),e.qZA()()(),e.TgZ(27,"div",12),e._UZ(28,"div",13),e.TgZ(29,"h3",14),e._uU(30),e.qZA(),e._UZ(31,"div",13),e.qZA()()()()()),2&o&&(e.xp6(4),e.Oqu(e.lcZ(5,11,"HTML.SIGNIN")),e.xp6(2),e.Q6J("formGroup",t.loginForm),e.xp6(3),e.Oqu(e.lcZ(10,13,"HTML.USERNAME")),e.xp6(2),e.s9C("placeholder",e.lcZ(12,15,"HTML.USERNAME")),e.xp6(2),e.Q6J("ngIf",null==t.loginForm.controls.username.errors?null:t.loginForm.controls.username.errors.required),e.xp6(1),e.Q6J("ngIf",t.loginForm.controls.username.hasError("minlength")),e.xp6(3),e.Oqu(e.lcZ(18,17,"HTML.PASSWORD")),e.xp6(2),e.s9C("placeholder",e.lcZ(20,19,"HTML.PASSWORD")),e.xp6(2),e.Q6J("ngIf",null==t.loginForm.controls.password.errors?null:t.loginForm.controls.password.errors.required),e.xp6(1),e.Q6J("ngIf",t.loginForm.controls.password.hasError("minlength")),e.xp6(8),e.Oqu(t.settings.name))},dependencies:[O.O5,a._Y,a.Fj,a.JJ,a.JL,a.Q7,a.sg,a.u,c.xw,c.Wh,c.yH,P.cs,Q.a8,H.Hw,L.Nt,d.KE,d.hX,d.TO,C.X$],styles:[".auth[_ngcontent-%COMP%]{white-space:nowrap;padding:7px 14px;font-weight:500}"]});const w=[{path:"",component:h,pathMatch:"full"}];class m{}m.\u0275fac=function(o){return new(o||m)},m.\u0275mod=e.oAB({type:m}),m.\u0275inj=e.cJS({imports:[O.ez,T.Bz.forChild(w),a.UX,F.m]})}}]);